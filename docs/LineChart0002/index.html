<head>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style> body { margin: 0; } </style>
    <link rel="preconnect" href="https://fonts.gstatic.com">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Lora&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
    <script src="https://d3js.org/d3.v6.min.js"></script>
</head>
<body>
    <div id="container">
        <!-- <div id="sections">
        </div> -->
        <!-- <button id="b1" class="off">сравнить</button> -->
        <div id="chart" style = "width: 100%; height: 100%;">
            <script>
                function scroller(){
                    let container = d3.select('body')
                    let dispatch = d3.dispatch('active', 'progress');
                    let sections = d3.selectAll('.step')
                    let sectionPositions
                    let currentIndex = -1
                    let containerStart = 0;

                    function scroll(){
                        d3.select(window)
                        .on('scroll.scroller', position)
                        .on('resize.scroller', resize)
                        resize();
                        let timer = d3.timer(function() {
                        position();
                        timer.stop();
                        });
                    }

                    function resize(){
                        sectionPositions = [];
                        let startPos;
                        sections.each(function(d, i) {
                            let top = this.getBoundingClientRect().top;

                            if (i === 0 ){
                                startPos = top;
                            }

                            sectionPositions.push(top - startPos);
                        });
                    }

                    function position() {
                        let pos = window.pageYOffset - 300 - containerStart;
                        let sectionIndex = d3.bisect(sectionPositions, pos);
                        sectionIndex = Math.min(sections.size()-1, sectionIndex);
                        if (currentIndex !== sectionIndex){
                        dispatch.call('active', this, sectionIndex);
                        currentIndex = sectionIndex;
                        }
                        let prevIndex = Math.max(sectionIndex - 1, 0);
                        let prevTop = sectionPositions[prevIndex]
                        let progress = (pos - prevTop) / (sectionPositions[sectionIndex]   - prevTop);
                        dispatch.call('progress', this, currentIndex, progress)
                    }

                    scroll.container = function(value) {
                        if (arguments.legth === 0){
                        return container
                        }
                        container = value
                        return scroll
                    }
                    scroll.on = function(action, callback){
                        dispatch.on(action, callback)
                    };
                    return scroll;
                };

                var W = document.getElementById('container').clientWidth,
                    H = document.getElementById('container').clientHeight;

                var Sc=1.2;

                var margin = {
                    top: W*0.5, 
                    bottom: H*0.5, 
                    right: W*0,
                    left: W*0
                    };
                
                var width = W - margin.left - margin.right;
                    height = H*0.09;

                var x = d3.scaleLinear().range([0, width])
                    .domain([0, 100]);
                var y = d3.scaleLinear().range([height, 0])
                    y.domain([0, 350]);

                var svg = d3.select("#chart").append("svg")
                    .attr("width", W)
                    .attr("height", H)
                    .append("g");

                svg.append("text")
                    .attr("opacity", 1)
                    .attr("id", "header")
                    .attr("x", 0)
                    .attr("y", 0)
                    .attr("alignment-baseline", "hanging")
                    .attr("text-anchor", "start")
                    .attr("fill", "#494a4d")
                    .text("Великолепная семерка ЕР");

                svg.append("text")
                    .attr("opacity", 1)
                    .attr("class", "textSmaller")
                    .attr("x", 0)
                    .attr("y", 36)
                    .attr("alignment-baseline", "hanging")
                    .attr("text-anchor", "start")
                    .attr("fill", "#494a4d")
                    .text("Как выглядит «серийное» голосование на 100 избирательных участках");

                svg.append("text")
                    .attr("opacity", 1)
                    .attr("class", "textSmaller")
                    .attr("x", 0)
                    .attr("y", H)
                    .attr("alignment-baseline", "ideographic")
                    .attr("text-anchor", "start")
                    .attr("fill", "#A6A6A6")
                    .text("Источник: «Единая Россия»");
                
                d3.csv("../data/LineChart0002/MskList3.csv").then( function(data) {
                    
                    var cand = [
                        ["АБАЕВ Герман Борисович"],
                        ["ЯЩУК Александр Михайлович"],
                        ["ЛОЕВ Семён Владимирович"],
                        ["БАЙР Марк Михайлович"],
                        ["БРЕДИХИН Антон Викторович"],
                        ["ДАНИЛОВА Анна Геннадьевна"],
                        ["БАБОШИНА Алина Олеговна"]
                    ]

                    var center;

                    cand.forEach(
                        function(c, i) {

                            let name = c[0];
                            let yMove = height*Sc*(i) + 66;

                            if (i==3) {
                                center = yMove;
                            };

                            cand[i].push(yMove);

                            let curChart = svg.append("g")
                                .attr("width", width)
                                .attr("height", height)
                                .attr("class", name+" chart")
                                .attr("opacity", 1)
                                .attr("transform", "translate("+margin.left+","+yMove+")");
                            
                            curChart.append("g")
                                .attr("opacity", 0)
                                .attr("transform", "translate(0," + height + ")")
                                .call(d3.axisBottom(x).tickSize(0));
                            
                            curChart.append("g")
                                .attr("opacity", 0)
                                .call(d3.axisLeft(y).tickSize(0));
                            
                            curChart.append("path")
                                .datum(data.slice(0, 100))
                                .attr("fill", "#494a4d")
                                .attr(
                                    "d", 
                                    d3.area()
                                        .curve(d3.curveStep)
                                        .x(d => x(data.indexOf(d)))
                                        .y0(y(0))
                                        .y1(d => y(d[name]))
                                );

                            curChart.append("text")
                                .attr("opacity", 1)
                                .attr("class", "textSmaller name")
                                .attr("x", 0)
                                .attr("y", height+15)
                                .attr("text-anchor", "start")
                                .attr("fill", "#A6A6A6")
                                .text(name);
                            
                        }
                    );

                    var charts = svg.selectAll(".chart"),
                        names = svg.selectAll(".name");

                    function off() {
                        charts.call(moverHome);
                        names.call(opaciter, 1);
                    };

                    function on() {
                        charts.call(moverCenter);
                        names.call(opaciter, 0);
                    };

                    off();

                    // Transitions

                    var NFS = 1200;

                    function opaciter(path, o) {
                        path
                            .transition("opaciter")
                            .duration(NFS)
                            .attr("opacity", o)
                    }

                    function moverCenter(path) {
                        path
                            .transition("moverCenter")
                            .duration(NFS)
                            .attr("opacity", 0.15)
                            .attr("transform", "translate("+margin.left+"," + center + ")");
                    };

                    function moverHome(path) {
                        path
                            .transition("moverHome")
                            .duration(NFS)
                            .attr("opacity", 1)
                            .attr(
                                "transform", 
                                function(d, i) {
                                    return "translate("+margin.left+"," + cand[i][1] + ")"
                                }
                            );
                    };

                    console.log(H);
                    console.log(svg);

                    if (H>W) {
                        let sections = d3.select("#container")
                            .append("div")
                            .attr("id", "#sections")
                            .style("z-index", 90);
                        sections
                            .append("section")
                            .attr("class", "step");
                        sections
                            .append("section")
                            .attr("class", "step");

                        d3.select("#chart").style("position", "fixed").style("z-index", 1);

                        var activationFunctions = [off, on];

                        let scroll = scroller().container(d3.select('#graphic'));
                            scroll();
                        let lastIndex, activeIndex = 0;

                        scroll.on('active', function(index){

                            activeIndex = index
                            let sign = (activeIndex - lastIndex) < 0 ? -1 : 1;
                            let scrolledSections = d3.range(lastIndex + sign, activeIndex + sign, sign);

                            scrolledSections.forEach(i => {
                                activationFunctions[i]()
                            })
                            lastIndex = activeIndex;
                        });
                    } else {


                        var BB = svg.append("text")
                            .attr("opacity", 1)
                            .attr("class", "off")
                            .attr("x", width*0.5)
                            .attr("y", H-50)
                            .attr("text-anchor", "middle")
                            .attr("fill", "#494a4d")
                            .text("сравнить");

                        // var BB = d3.select("#container")
                        //     .append("button")
                        //     .attr("id", "b1")
                        //     .attr("class", "off")
                        //     .html("сравнить")
                        //     .style("z-index", 90);
                        // var BB = d3.select("#b1");
                        BB.on("click", function() {
                                let curState = BB.node().getAttribute("class");
                                
                                if (curState=="off") {
                                    on()
                                    BB.attr("class", "on");
                                } else {
                                    off();
                                    BB.attr("class", "off");
                                }
                            }
                        );
                    }

                });
                
            </script>
        </div>
    </div>
</body>