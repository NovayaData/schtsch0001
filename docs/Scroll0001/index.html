<head>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style> body { margin: 0; } </style>
    <link rel="preconnect" href="https://fonts.gstatic.com">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Lora&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
    <script src="https://d3js.org/d3.v6.min.js"></script>
</head>
<body>

    <!-- <img class="picture" alt="test2" src="https://s0.rbk.ru/v6_top_pics/media/img/1/90/756184010255901.jpg"> -->
    <!-- bgcolor="#f7f7f7" -->
    <!-- style="overflow: hidden;" -->

    <div id="headers">
        <h1 class="header1">Хронология наблюдений ОБСЕ</h1>
    </div>

    <div id="graphic">

        <div id="paragraphs">
        </div>

        

        <div id="sections">
            <!-- <section class="step"
                style="background-image: url('https://news.usni.org/wp-content/uploads/2014/07/12013-2.jpg'); background-size: 100%; background-position:center;">
                1</section> -->
            <section class="step">1</section>
            <section class="step">2</section>
            <section class="step">3</section>
            <section class="step">4</section>
            <section class="step">5</section>
            <section class="step">6</section>
            <section class="step">7</section>
            <section class="step">8</section>
            <section class="step">9</section>
            <section class="step">10</section>
            <section class="step">11</section>
            <section class="step">12</section>
            <section class="step">13</section>
            <section class="step">14</section>
            <section class="step">15</section>
            <section class="step">16</section>
            <section class="step">17</section>
            <section class="step">18</section>
            <section class="step">19</section>
            <section class="step">20</section>
            <section class="step">21</section>
            <section class="step">22</section>
            <section class="step">23</section>
            <section class="step">24</section>
            <section class="step">25</section>
            <section class="step">26</section>
            <section class="step">27</section>
            <section class="step">28</section>
            <section class="step">29</section>
            <section class="step">30</section>
            <section class="step">31</section>
            <section class="step">32</section>
            <section class="step">33</section>
            <section class="step">34</section>
            <section class="step">35</section>
        </div>

        <div id="chartArea" >
            <script>

                function scroller(){
                    let container = d3.select('body')
                    let dispatch = d3.dispatch('active', 'progress');
                    let sections = d3.selectAll('.step')
                    let sectionPositions
                    let currentIndex = -1
                    let containerStart = 0;

                    function scroll(){
                        d3.select(window)
                        .on('scroll.scroller', position)
                        .on('resize.scroller', resize)
                        resize();
                        let timer = d3.timer(function() {
                        position();
                        timer.stop();
                        });
                    }

                    function resize(){
                        sectionPositions = [];
                        let startPos;
                        sections.each(function(d, i) {
                            let top = this.getBoundingClientRect().top;

                            if (i === 0 ){
                                startPos = top;
                            }

                            sectionPositions.push(top - startPos);
                        });
                    }

                    function position() {
                        let pos = window.pageYOffset - 300 - containerStart;
                        let sectionIndex = d3.bisect(sectionPositions, pos);
                        sectionIndex = Math.min(sections.size()-1, sectionIndex);
                        if (currentIndex !== sectionIndex){
                        dispatch.call('active', this, sectionIndex);
                        currentIndex = sectionIndex;
                        }
                        let prevIndex = Math.max(sectionIndex - 1, 0);
                        let prevTop = sectionPositions[prevIndex]
                        let progress = (pos - prevTop) / (sectionPositions[sectionIndex]   - prevTop);
                        dispatch.call('progress', this, currentIndex, progress)
                    }

                    scroll.container = function(value) {
                        if (arguments.legth === 0){
                        return container
                        }
                        container = value
                        return scroll
                    }
                    scroll.on = function(action, callback){
                        dispatch.on(action, callback)
                    };
                    return scroll;
                };

                function getColor(v) {
                    if (279.4>v && v>=0){
                        return "#ffed26"
                    } else if (2695.8>v && v>=279.4){
                        return "#fbbf00"
                    } else if (5163>v && v>=2695.8){
                        return "#ee9100"
                    } else if (7207.2>v && v>=5163){
                        return "#da6513"
                    } else if (v>=7207.2){
                        return "#bf381d"
                    }
                }

                function getColorG(v) {
                    if (279.4>v && v>=0){
                        return "#ececec"
                    } else if (2695.8>v && v>=279.4){
                        return "#cfcfcf"
                    } else if (5163>v && v>=2695.8){
                        return "#b0b0b0"
                    } else if (7207.2>v && v>=5163){
                        return "#949494"
                    } else if (v>=7207.2){
                        return "#787878"
                    }
                }

                const W = document.getElementById('chartArea').clientWidth,
                    H = document.getElementById('chartArea').clientHeight,
                    margin = {top: H*0.06, right: W*0.06, bottom: H*0.06, left: W*0.06},
                    width = W - margin.left - margin.right,
                    height = H - margin.top - margin.bottom;

                var svg = d3.select("#chartArea").append("svg")
                    .attr("width", W)
                    .attr("height", H)
                    .append("g")
                        

                svg.append("defs").append("clipPath")
                        .attr("id", "clip")
                    .append("rect")
                        .attr("width", width)
                        .attr("height", H);

                var focusCenter = -height/6;
                var curFocusPosition = 0;

                var focus = svg.append("g")
                    .attr("class", "focus")
                    .attr("width", width)
                    .attr("height", height)
                    .attr("transform", 
                            "translate(" + margin.left + "," + margin.top + ")");

                var parseTime = d3.timeParse("%Y-%m-%d");
                var bandWidth;

                var wurstH = H*0.035;
                var NFS = 250;

                // var sizeCondition = 0;
                var cleanDate = parseTime("2016-01-01");

                Promise.all([
                    d3.csv("../data/Scroll0001/osce_violations_Ukraine.csv"),
                    d3.json('../data/Scroll0001/article_script.json'),
                    d3.csv("../data/Scroll0001/google_search_index_Donbas.csv")
                ]).then(([data, articleScript, googleData]) => {

                    const activationFunctions = [
                                [dropAll, ["p0", "zero", "black"]],
                                [dropAll, ["p1", "real", "black"]],
                                [dropAll, ["p1", "real", "colored"]],
                                [dropAll, ["p2", "wurst", ""]],
                            [getSize, ["clean", "p2", 0, []]],
                            [getSize, ["clean", "p2", 1, []]],
                        [getAction, ["e1", "p3", [], []]],
                        [getAction, ["e1", "p4", [], []]],
                        [getAction, ["e2", "p5", [], []]],
                        [getAction, ["e3", "p6", [], []]],
                                [dropAll, ["p7", "wurst", ""]],
                                [dropAll, ["p8", "wurst", ""]],
                        [getAction, ["e4", "p9", [], []]],
                        [getAction, ["e5", "p10", [], []]],
                                [dropAll, ["p11", "wurst", ""]],
                        [getAction, ["e6", "p12", [], []]],
                                [dropAll, ["p13", "wurst", ""]],
                        [getAction, ["e7", "p14", [], []]],
                                [dropAll, ["p15", "wurst", ""]],
                        [getAction, ["e8", "p16", [], []]],
                        [getAction, ["e8", "p17", [], []]],
                        [getAction, ["e8", "p18", [], []]],
                        [getAction, ["e9", "p19", [], []]],
                        [getAction, ["e9", "p20", [], []]],
                                [dropAll, ["p21", "wurst", ""]],
                        [getAction, ["e8", "p22", [], []]],
                        [getAction, ["e8", "p23", [], []]],
                        [getAction, ["e8", "p24", [], []]],
                        [getAction, ["e10", "p25", [], []]],
                                [dropAll, ["p26", "wurst", ""]],
                                [dropAll, ["p27", "wurst", ""]],
                                [dropAll, ["p28", "wurst", ""]],
                                [dropAll, ["p29", "wurst", ""]],
                                [dropAll, ["p30", "wurst", ""]],
                                [dropAll, ["pEnd", "real", "black"]]
                    ];

                    // Finish page

                    const paragraphs = d3.select("#paragraphs");
                    // const sections = d3.select("#sections");

                    Object.keys(articleScript.paragraphs).forEach(
                        function(p) {
                            // paragraphs
                            //     .append("span")
                            //     .attr("id", "f"+p)
                            //     .style("opacity", 0)
                            //     .attr("class", "paragraphFalseText")
                            //     .html(articleScript.paragraphs[p]);
                            paragraphs
                                .append("span")
                                .attr("id", p)
                                .style("opacity", 0)
                                .attr("class", "paragraphText")
                                .html(articleScript.paragraphs[p].join('<p></p>'));
                        }
                    );

                    var curParagraph = "p0";
                    getText(curParagraph);

                    var navigatorX = activationFunctions.map(
                        d => { return margin.bottom + height / (activationFunctions.length - 1) * activationFunctions.indexOf(d) }
                    );

                    var circlesContainer = svg.append("g");
                    var hTr = W-margin.right/2;

                    function addCircle(i, hPos, color) {
                        

                        circlesContainer
                            .append("circle")
                            .attr("id", "c"+i)
                            .attr("r", "4px")
                            .attr("fill", color)
                            .attr("transform", 
                                "translate(" + hTr + "," + hPos + ")");
                    };

                    navigatorX.forEach(
                        function(d, i) {
                            addCircle(i, d, "#ececec")
                        }
                    );

                    addCircle("theCircle", navigatorX[0], "#b0b0b0");
                    const theCircle = circlesContainer.select("#ctheCircle");

                    
                    // d3.selectAll(".step:last-of-type").style("margin-bottom","50vh");

                    // Transform data

                    var marksData = {};
                    data.forEach(d => {
                        d.dateStr = d.date;
                        d.date = parseTime(d.date);
                        d.episode = "episode ";

                        marksData[d.dateStr] = [d.weeksum, d.date];

                        Object.keys(articleScript.episodes).forEach( function(eKey) {

                            let eList = articleScript.episodes[eKey];

                            eList.forEach(function(e) {

                                let minDate = parseTime(e[0]),
                                    maxDate = parseTime(e[1]);

                                if (d.date >= minDate && d.date <= maxDate) {
                                    d.episode += eKey+" ";
                                };

                            })
                        });

                    });

                    var fakeBars = [];
                    
                    Object.keys(articleScript.episodes).forEach( function(eKey) {

                        let eList = articleScript.episodes[eKey];

                        eList.forEach(function(e) {
                            let minDate = parseTime(e[0]),
                                maxDate = parseTime(e[1]);

                            fakeBars.push([eKey, minDate, maxDate])
                        })
                    });

                    googleData.forEach(d => {
                        d.date = parseTime(d.date),
                        d.search_index = parseFloat(d.search_index)
                    });

                    // Draw

                    var xMin = d3.min(data, function(d) { return d.date; });
                    var xMax = d3.max(data, function(d) { return d.date; });

                    var weeksumMax = d3.max(data, function(d) { return parseInt(d.weeksum); });
                    var yScaler = (H*0.7)/weeksumMax;

                    var bandWidth = width/data.length+0.4;

                    Math.round(weeksumMax/10000)*10000

                    var x = d3.scaleTime()
                        .range([0, width]);

                    var y = d3.scaleLinear()
                        .range([height, height-Math.round(weeksumMax/10000)*10000*yScaler]);

                    var y2 = d3.scaleLinear()
                        .range([height, height-Math.round(weeksumMax/10000)*10000*yScaler]);

                    x.domain([xMin, xMax]);

                    function addXAx(i, o, h, t, f) {
                        focus.append("g")
                            .attr("clip-path", "url(#clip)")
                            .attr("id", i)
                            .attr("opacity", o)
                            .attr("transform", "translate(0," + h + ")")
                            .call(
                                d3.axisBottom(x)
                                    .tickSize(0)
                                    .ticks(t)
                                    .tickFormat(f)
                                )
                            .selectAll("text")
                                .attr('text-anchor', 'start')
                                .attr("class", "textSmaller");
                    };
                    
                    addXAx("Xmonths", 0, height+5, d3.timeMonth, d3.timeFormat("%-m"));
                    addXAx("X", 1, height+20, d3.timeYear, d3.timeFormat("| %Y"));

                    var y2x = bandWidth*1.5+width;

                    function addY(aY, domainR, tranlateX, textClass, i, anc) {
                        aY.domain([0, domainR]);
                        focus.append("g")
                            .attr("id", i)
                            .attr("opacity", 1)
                            .attr("transform", "translate("+tranlateX+",0)")
                            .call(d3.axisLeft(aY)
                                .tickSize(0)
                                .tickFormat(d => { return d3.format(",.0f")(d).replace(",", ' ') } ))
                            .selectAll("text")
                                .attr('text-anchor', anc)
                                .attr("class", textClass);
                    };

                    addY(y, 40000, 0, "textSmaller", "Y", "end");
                    addY(y2, 100, y2x, "textSmaller2", "Y2", "start");
                    focus.select("#Y").attr("opacity", 0);

                    function dropDomains() {
                        focus.selectAll(".domain")
                            .remove()
                    };

                    dropDomains();

                    var barsFake = focus.append("g");
                    barsFake.attr("clip-path", "url(#clip)");

                    fakeBars.forEach( function(fb) {
                        barsFake.append("rect")
                            .attr("class", fb[0])
                            .attr("fill", "#f0f1f2")
                            // .attr("id", function(d) { return iPref+d.dateStr; })
                            .attr("x", x(fb[1]))
                            .attr("width", x(fb[2])-x(fb[1])+bandWidth)
                            .attr("height", 40000*yScaler)
                            .attr("y", y(40000))
                            .attr("opacity", 0);
                    });

                    var bars = focus.append("g");
                    
                    function addBars(group, color, iPref, cSuf, defaultH, o) {
                        group.attr("clip-path", "url(#clip)");
                        group.selectAll("bar")
                        .data(data)
                        .enter().append("rect")
                            .attr("class", function(d) { return d.episode + cSuf; })
                            .attr("fill", color)
                            .attr("id", function(d) { return iPref+d.dateStr; })
                            .attr("x", function(d) { return x(d.date); })
                            .attr("width", bandWidth)
                            .attr("height", defaultH*yScaler)
                            .attr("y", y(defaultH))
                            // .attr("height", function(d) { return d.weeksum*yScaler})
                            // .attr("y", function(d) { return y(d.weeksum); })
                            .attr("opacity", o);
                    };

                    // addBars(barsFake, "#f0f1f2", "bf", " fake", 40000, 0);
                    addBars(bars, "#494a4d", "b", " wurst", 0, 1);

                    function colorise(date, value) {
                        if (date < cleanDate) {
                            return getColorG(value);
                        } else {
                            return getColor(value);
                        }
                    };

                    function addLine(color, lineWidth) {
                        focus.append("g").attr("clip-path", "url(#clip)")
                        .append("path")
                        .datum(googleData)
                        .attr("fill", "none")
                        .attr("opacity", 1)
                        .attr("stroke-width", lineWidth)
                        .attr("stroke", color)
                        .attr("stroke-linejoin", "round")
                        .attr("stroke-linecap", "round")
                        .attr(
                            "d", 
                            d3.line()
                            .curve(d3.curveCatmullRom)
                            .x(d => x(d.date))
                            .y(d => y(d.search_index*40000))
                        );
                    }

                    addLine("#ffffff", 6);
                    addLine("#00abe5", 2);

                    const marks = focus.append("g");
                    marks.attr("clip-path", "url(#clip)");

                    Object.keys(articleScript.marks).forEach(
                        function(m) {
                            let mList =  articleScript.marks[m];
                            mList.forEach(
                                function(mark) {
                                    let markWidth = x(marksData[mark[0]][1])+bandWidth/2;
                                    marks.append("circle")
                                        .attr("id", "m"+mark[0])
                                        .attr("class", "mark "+m)
                                        .attr("r", bandWidth*1.5)
                                        .attr("fill", "#00ace5")
                                        .attr("opacity", 0)
                                        .attr("text", mark[1])
                                        .attr("cx", markWidth)
                                        .attr("cy", height-wurstH-10);
                                        // .attr("cy", y(marksData[mark[0]][0])-10);
                                }
                            )
                        }
                    );

                    function getFormatedDate(date) {
                        date = parseTime(date);
                        let mo = new Intl.DateTimeFormat('ru', { month: 'short' }).format(date);
                        let da = new Intl.DateTimeFormat('ru', { day: 'numeric' }).format(date);
                        return `${da} ${mo}`;
                    };

                    // Actions

                    function paintCircle(i) {
                        circlesContainer.select("circle").filter()
                    };

                    function marker(mids, mode) {
                        if (mids) {
                            mids.forEach(
                                function(mid) {
                                    let curMarks = marks.select("."+mid)
                                    curMarks.call(markOn, mode);
                                    // if (mode=="on") {
                                    //     curMarks.call(wurstOpaciter, 1);;
                                    // } else if (mode=="off") {
                                    //     curMarks.call(wurstOpaciter, 0)
                                    // };
                                }
                            ) 
                        }
                    };

                    function markOn(path, mode) {
                        path
                            .attr("opacity", function(d) {
                                if (mode=="on") {
                                    return 1;
                                } else if (mode=="off") {
                                    return 0;
                                } else {
                                    alert("what??" + " " + curClass + " " + mode)
                                }
                            })
                            .attr("class", function() {

                                let curClass = this.getAttribute("class");

                                if (!curClass.includes("on") && mode=="on") {
                                    return curClass.replace("mark", "mark on");
                                } else if (curClass.includes("on") && mode=="on") {
                                    return curClass;
                                } else if (mode=="off") {
                                    return curClass.replace("mark on", "mark");
                                } else {
                                    alert("what?" + " " + curClass + " " + mode)
                                }
                            });
                            
                    }

                    function getAction(args) {

                        let eid = args[0],
                            pid = args[1],
                            mids = args[2],
                            midsDel = args[3];

                        marker(mids, "on");
                        marker(midsDel, "off");

                        if (eid && eid!="clean") {
                            getReal(eid, "colored")
                        } else if (eid=="clean") {
                            getWurst();
                        };

                        if (pid && pid!="clean") {
                            getText(pid)
                        } else if (pid=="clean") {
                            getBlanc();
                        };

                    };

                    function getReal(eid, colorMode) {
                        bars.selectAll("rect").filter(function() {
                                return !this.classList.contains(eid)
                        }).call(pookColor).call(pook).call(wurstOpaciter, 0.5)
                        // .call(wurstOpaciter, 0.5)

                        barsFake.selectAll("rect").filter(function() {
                                return !this.classList.contains(eid)
                        }).call(wurstOpaciter, 0)
                        barsFake.selectAll("."+eid).call(wurstOpaciter, 1)

                        let curReal = bars.selectAll("."+eid)

                        curReal.call(pik).call(pikColor, colorMode).call(wurstOpaciter, 1);
                        // .call(wurstOpaciter, 1)

                        let curMarksIds = curReal.nodes().map(function(d) { return d.id.replace("b", "m")  });
                        if (curMarksIds) {
                            marks.selectAll(".on").filter( function() { return curMarksIds.includes(this.id) } )
                                .call(pikMark);
                            marks.selectAll(".on").filter( function() { return !curMarksIds.includes(this.id) } )
                                .call(pookMark, 0.5);
                        };

                        marks.selectAll("circle:not(.on)").call(pookMark, 0);

                        focus.select("#Xmonths").attr("opacity", 1);
                        focus.select("#Y").attr("opacity", 1);
                    };

                    function getSize(args) {
                        let eid = args[0],
                            pid = args[1],
                            sizeCondition = args[2],
                            midsDel = args[3];

                        marker(midsDel, "off");
                        marks.selectAll("circle:not(.on)").call(pookMark, 0);

                        if (eid=="clean") {
                            getWurst()
                        };

                        if (sizeCondition==1) {
                            resizer(cleanDate);
                        } else {
                            resizer(xMin);
                        };

                        getText(pid);
                    };

                    function getText(pid) {
                        // d3.selectAll(".paragraphFalseText").filter(function() {
                        //     return this.id != "f"+pid
                        // }).call(textOpaciter, 0);
                        // d3.select("#f"+pid).call(textOpaciter, 0);
                        // fakeText

                        d3.selectAll(".paragraphText").filter(function() {
                            return this.id != pid
                        }).call(textOpaciter, 0);
                        d3.select("#"+pid).call(textOpaciter, 1);
                    };

                    function textMover(path) {
                        path
                            .transition("textMover")
                            .duration(NFS*2)
                            .style("margin-top", 
                                 "9%");
                    };

                    function textOpaciter(path, o) {
                        path
                            .transition("textOpaciter")
                            .duration(NFS)
                            .style("opacity", o);
                    }

                    function getWurst() {
                        focus.select("#Y").attr("opacity", 0);
                        focus.select("#Xmonths").attr("opacity", 0);
                        barsFake.selectAll("rect").call(wurstOpaciter, 0)

                        bars.selectAll(".wurst")
                            .call(wurstOpaciter, 1)
                            .call(pookColor)
                            .call(pook)

                        marks.selectAll(".on").call(pookMark, 1);
                    };

                    function getZero() {
                        focus.select("#Y").attr("opacity", 0);
                        focus.select("#Xmonths").attr("opacity", 0);
                        barsFake.selectAll("rect").call(wurstOpaciter, 0)

                        bars.selectAll(".wurst")
                            .call(wurstOpaciter, 1)
                            .call(pookColor)
                            .call(pookZero)

                        marks.selectAll(".on").call(pookMark, 1);
                    };

                    function getBlanc() {
                        d3.selectAll(".paragraphText").call(textOpaciter, 0);
                    };

                    function dropAll(args) {
                        let pid = args[0],
                            barType = args[1],
                            colorMode = args[2];

                        if (barType=="wurst") {
                            getWurst();
                        } else if (barType=="real") {
                            getReal("wurst", colorMode);
                        } else if (barType=="zero") {
                            getZero();
                        };
                        
                        getText(pid);
                    };

                    function resizer(leftDate) {

                        var s = Array(leftDate, xMax);

                        bandWidth = width/data.filter(function(d) { return d.date > leftDate;}).length+0.4;
                        x.domain(s);

                        bars.selectAll("rect").call(resizeBars);

                        barsFake.selectAll("rect").call(resizeFakeBars);

                        focus.selectAll("path").call(resizeLine);
                        focus.select("#X").call(resizeAx, x, d3.timeYear, "| %Y");
                        focus.select("#Xmonths").call(resizeAx, x, d3.timeMonth, "%-m");
                        focus.selectAll(".mark").call(resizeMarks);
                        dropDomains();

                    };

                    // Transitions
                    
                    function resizeMarks(path) {
                        path
                            .transition("resizeBars")
                            .duration(NFS)
                            .attr("cx", 
                                function() {
                                    return x(marksData[this.id.replace("m", "")][1])+bandWidth/2
                                });
                    }

                    function resizeLine(path) {
                        path
                            .transition("resizeLine")
                            .duration(NFS)
                            .attr("d", d3.line()
                                .curve(d3.curveCatmullRom)
                                .x(function(d) { return x(d.date) })
                                .y(function(d) { return y(d.search_index*40000) }))
                    };

                    function resizeBars(path) {
                        path
                            .transition("resizeBars")
                            .duration(NFS)
                            .attr("width", bandWidth)
                            .attr("x", function(d) { return x(d.date); });
                    };

                    function resizeFakeBars(path) {
                        path
                            .transition("resizeFakeBars")
                            .duration(NFS)
                            .attr("x", function(d, i) {return x(fakeBars[i][1]); })
                            .attr("width", function(d, i) { return x(fakeBars[i][2])-x(fakeBars[i][1])+bandWidth ; });
                    };

                    function resizeAx(path, a, t, f) {
                        path
                            .transition("resizeAx")
                            .duration(NFS)
                            .call(d3.axisBottom(a)
                                .tickSize(0)
                                .ticks(t)
                                .tickFormat(d3.timeFormat(f))
                            )
                        .selectAll("text")
                            .attr('text-anchor', 'start')
                            .attr("class", "textSmaller");
                    }

                    function wurstOpaciter(path, v) {
                        path
                            .transition("wurstOpaciter")
                            .duration(NFS)
                            .attr("opacity", v);
                    };

                    function pik(path) {
                        path
                            .transition("pik")
                            .duration(NFS)
                            .attr("height", function(d) { 
                                return d.weeksum*yScaler;
                            })
                            .attr("y", function(d) { return y(d.weeksum); });
                    };

                    function pikMark(path) {
                        
                        path
                            .transition("pikMark")
                            .duration(NFS)
                            .attr("cy", 
                                function() {
                                    return y(marksData[this.id.replace("m", "")][0])-10
                                }
                            )
                            .attr("opacity", 1);
                        };

                    function pikColor(path, colorMode) {
                        path
                            .transition("pikColor")
                            .duration(NFS)
                            .attr("fill", function(d) {

                                if (colorMode == "black") {
                                    return "#494a4d"
                                    // return "#F0F1F2"
                                } else if (colorMode == "colored") {
                                    return colorise(d.date, d.weeksum)
                                }

                            });
                    };

                    function pookZero(path) {
                        path
                            .transition("pookZero")
                            .duration(NFS)
                            .attr("height", 0)
                            .attr("y", y(0));
                    };

                    function pook(path) {
                        path
                            .transition("pook")
                            .duration(NFS)
                            .attr("height", wurstH)
                            .attr("y", height-wurstH);
                    };

                    function pookColor(path) {
                        path
                            .transition("pookColor")
                            .duration(NFS)
                            .attr("fill", function(d) { return colorise(d.date, d.weeksum) });
                    };

                    function pookMark(path, o) {
                        path
                            .transition("pookColor")
                            .duration(NFS)
                            .attr("cy", height-wurstH-10)
                            .attr("opacity", o);
                    }

                    function navigate(path, i) {
                        path
                            .transition("navigate")
                            .duration(NFS)
                            .attr("transform", 
                                "translate(" + hTr + "," + navigatorX[i] + ")")
                    };

                    // Scroll

                    let scroll = scroller().container(d3.select('#graphic'));
                        scroll();
                    let lastIndex, activeIndex = 0;

                    scroll.on('active', function(index){
                        // d3.selectAll('.step')
                        //     .transition().duration(NFS*2)
                        //     .style('opacity', function (d, i) {return i === index ? 1 : 0;});

                        activeIndex = index
                        let sign = (activeIndex - lastIndex) < 0 ? -1 : 1;
                        let scrolledSections = d3.range(lastIndex + sign, activeIndex + sign, sign);

                        scrolledSections.forEach(i => {
                            activationFunctions[i][0](
                                activationFunctions[i][1]
                                // activationFunctions[i][2]
                            );
                            theCircle.call(navigate, i);
                        })
                        lastIndex = activeIndex;
                    });
                });

            </script>
        </div>
    </div>
</body>
