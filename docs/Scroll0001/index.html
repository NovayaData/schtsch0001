<head>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style> body { margin: 0; } </style>
    <link rel="preconnect" href="https://fonts.gstatic.com">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
    <script src="https://d3js.org/d3.v6.min.js"></script>
</head>
<body>
    <!-- bgcolor="#212226" -->
    <!-- style="overflow: hidden;" -->
    <div id="headers">
        <h1 class="header1">Хронология наблюдений ОБСЕ</h1>
    </div>

    <div id="graphic">
        <div id="sections">
            <section class="step">Че там у Дата-отдела?</section>
            <section class="step">На первом, самом горячем этапе войны, данных не было и нет.</section>
            <section class="step">_</section>
            <section class="step">В какой-то момент ОБСЕ развернули мониторинговую систему, но собирали они плохо.</section>
            <section class="step">_</section>
            <section class="step">_</section>
            <section class="step">Поэтому мы их не взяли...</section>
            <section class="step">_</section>
            <section class="step">Ого пик!</section>
            <section class="step">_</section>
            <section class="step">И второй!</section>
            <section class="step">Конец...?</section>
        </div>
        <div id="chartArea" >
                <!-- style = "height: 100%;  width: 100%;" -->
                <script>

                    const articleScript = {
                        "episodes" : {
                            "e1" : ["2014-04-06", "2015-04-12"],
                            "e2" : ["2015-04-19", "2015-12-27"],
                            "e3" : ["2016-12-18", "2017-05-28"],
                            "e4" : ["2018-09-30", "2019-01-06"]
                        }
                    };

                    const W = document.getElementById('chartArea').clientWidth,
                        H = document.getElementById('chartArea').clientHeight,
                        margin = {top: W*0.03, right: W*0.03, bottom: H*0.10, left: W*0.03},
                        width = W - margin.left - margin.right,
                        height = H - margin.top - margin.bottom;

                    function getColor(v) {
                        if (279.4>v && v>=0){
                            return "#ffed26"
                        } else if (2695.8>v && v>=279.4){
                            return "#fbbf00"
                        } else if (5163>v && v>=2695.8){
                            return "#ee9100"
                        } else if (7207.2>v && v>=5163){
                            return "#da6513"
                        } else if (v>=7207.2){
                            return "#bf381d"
                        }
                    }

                    function getColorG(v) {
                        if (279.4>v && v>=0){
                            return "#e3e4e5"
                        } else if (2695.8>v && v>=279.4){
                            return "#adafb0"
                        } else if (5163>v && v>=2695.8){
                            return "#7a7c7f"
                        } else if (7207.2>v && v>=5163){
                            return "#4b4d50"
                        } else if (v>=7207.2){
                            return "#212226"
                        }
                    }

                    var svg = d3.select("#chartArea").append("svg")
                        .attr("width", W)
                        .attr("height", H)
                        .append("g")
                            

                    svg.append("defs").append("clipPath")
                            .attr("id", "clip")
                        .append("rect")
                            .attr("width", width)
                            .attr("height", H);

                    var focus = svg.append("g")
                        .attr("class", "focus")
                        .attr("width", width-margin.left-margin.right)
                        .attr("height", H)
                        .attr("transform", 
                                "translate(" + margin.left + ",-" + H*0.25 + ")");

                    var parseTime = d3.timeParse("%Y-%m-%d");
                    var bandWidth;

                    var wurstH = H*0.035;
                    var NFS = 250;
                    
                    d3.csv("viotest.csv").then( function(data) {

                        function scroller(){
                            let container = d3.select('body')
                            let dispatch = d3.dispatch('active', 'progress');
                            let sections = d3.selectAll('.step')
                            let sectionPositions
                            let currentIndex = -1
                            let containerStart = 0;

                            function scroll(){
                                d3.select(window)
                                .on('scroll.scroller', position)
                                .on('resize.scroller', resize)
                                resize();
                                let timer = d3.timer(function() {
                                position();
                                timer.stop();
                                });
                            }

                            function resize(){
                                sectionPositions = [];
                                let startPos;
                                sections.each(function(d, i) {
                                let top = this.getBoundingClientRect().top;
                                if (i === 0 ){
                                    startPos = top;
                                }
                                sectionPositions.push(top - startPos)
                                });
                            }

                            function position() {
                                let pos = window.pageYOffset - 300 - containerStart;
                                let sectionIndex = d3.bisect(sectionPositions, pos);
                                sectionIndex = Math.min(sections.size()-1, sectionIndex);
                                if (currentIndex !== sectionIndex){
                                dispatch.call('active', this, sectionIndex);
                                currentIndex = sectionIndex;
                                }
                                let prevIndex = Math.max(sectionIndex - 1, 0);
                                let prevTop = sectionPositions[prevIndex]
                                let progress = (pos - prevTop) / (sectionPositions[sectionIndex]   - prevTop);
                                dispatch.call('progress', this, currentIndex, progress)
                            }

                            scroll.container = function(value) {
                                if (arguments.legth === 0){
                                return container
                                }
                                container = value
                                return scroll
                            }
                            scroll.on = function(action, callback){
                                dispatch.on(action, callback)
                            };
                            return scroll;
                        };

                        let scroll = scroller().container(d3.select('#graphic'));
                        scroll();
                        let lastIndex, activeIndex = 0;

                        scroll.on('active', function(index){
                            d3.selectAll('.step')
                                .transition().duration(NFS)
                                .style('opacity', function (d, i) {return i === index ? 1 : 0.1;});

                            activeIndex = index
                            let sign = (activeIndex - lastIndex) < 0 ? -1 : 1;
                            let scrolledSections = d3.range(lastIndex + sign, activeIndex + sign, sign);
                            scrolledSections.forEach(i => {
                                activationFunctions[i][0](activationFunctions[i][1]);
                            })
                            lastIndex = activeIndex;
                        });

                        // Transform date

                        data.forEach(d => {
                            d.dateStr = d.date;
                            d.date = parseTime(d.date);
                        });

                        Object.keys(articleScript.episodes).forEach( function(e) {
                            let minDate = parseTime(articleScript["episodes"][e][0]),
                                maxDate = parseTime(articleScript["episodes"][e][1]);
                            
                            data.forEach(d => {
                                if (d.date >= minDate && d.date <= maxDate) {
                                    d.episode = e;
                                }
                            })
                        });

                        var curYear = "0"
                        data.forEach(d => {
                            let dYear = d.date.getFullYear().toString();
                            if (dYear != curYear) {
                                d.yearlabel = dYear;
                                curYear = dYear;
                            } else {
                                d.yearlabel = "0";
                            };
                        });

                        var xMin = d3.min(data, function(d) { return d.date; });
                        var xMax = d3.max(data, function(d) { return d.date; });

                        weeksumMax = d3.max(data, function(d) { return parseInt(d.weeksum); });
                        yScaler = (H*0.7)/weeksumMax;

                        // console.log(yScaler);

                        var cleanDate = parseTime("2016-01-03");

                        var x = d3.scaleTime()
                            .range([0, width]);

                        var y = d3.scaleLinear()
                            .range([height, height-40000*yScaler]);

                        x.domain([xMin, xMax]);
                        focus.append("g")
                            .attr("id", "X")
                            .attr("opacity", 0)
                            .call(d3.axisBottom(x).tickSize(0))
                            .selectAll("text").remove();

                        y.domain([0, 40000]);
                        focus.append("g")
                            .attr("id", "Y")
                            .attr("opacity", 0)
                            .call(d3.axisLeft(y)
                                .tickSize(0)
                                .tickFormat(d => { return d3.format(",.0f")(d).replace(",", ' ') } ));
                            // .selectAll("text");

                        var bars = focus.append("g");
                        bandWidth = width/data.length;

                        const years = bars.append("g")
                            .attr("id", "years");

                        const dates = focus.append("g")
                            .attr("id", "dates");

                        bars.attr("clip-path", "url(#clip)");
                        bars.selectAll("bar")
                        .data(data)
                        .enter().append("rect")
                            .attr("class", function(d) { return d.episode; })
                            .attr("fill", function(d) {
                                if (d.date < cleanDate) {
                                    return getColorG(d.weeksum);
                                } else {
                                    return getColor(d.weeksum);
                                }})
                            .attr("id", function(d) { return d.dateStr; })
                            .attr("x", function(d) { 
                                if ( d.yearlabel!="0" ) {
                                    years
                                        .append("text")
                                        .attr("id", "y"+d.dateStr)
                                        .attr("class", "textSmall move")
                                        .attr('text-anchor', 'start')
                                        .attr("x", x(d.date))
                                        .attr("y", height+30)
                                        .text("| "+d.yearlabel)
                                };
                                return x(d.date); 
                            })
                            .attr("width", bandWidth)
                            .attr("y", y(0))
                            .attr("height", 10)
                            .attr("opacity", 1);
                        
                        bars.selectAll("rect")
                            .call(pook);

                        var showY = 0;

                        function getFormatedDate(date) {
                            date = parseTime(date);
                            let mo = new Intl.DateTimeFormat('ru', { month: 'short' }).format(date);
                            let da = new Intl.DateTimeFormat('ru', { day: 'numeric' }).format(date);
                            return `${da} ${mo}`;
                        };

                        function getReal(epid) {

                            bars.selectAll("rect").filter(function() {
                                return !this.classList.contains(epid)
                            }).call(wurstOpaciter, 0.25)

                            let episodeBars = d3.selectAll("."+epid);
                            episodeBars
                                .call(pik);

                            if (showY==1) {
                                focus.select("#Y").attr("opacity", 1);
                            };
                            
                            var r = episodeBars.nodes().length - 1;
                            var leftDate = episodeBars.nodes()[0];
                            var rightDate = episodeBars.nodes()[r];

                            lDate = leftDate.getAttribute("id")
                            rDate = rightDate.getAttribute("id")

                            lText = getFormatedDate(lDate);
                            rText = getFormatedDate(rDate);

                            dates
                                .call(addDay, "d"+lDate, lText, leftDate.getAttribute("x"), "end")
                                .call(addDay, "d"+rDate, rText, parseFloat(rightDate.getAttribute("x"))+bandWidth, "start");

                        };

                        function addDay(path, i, dayText, xPos, al) {
                            path 
                                .append("text")
                                .attr("id", i)
                                .attr("class", "textSmaller move")
                                .attr('text-anchor', al)
                                .attr("x", xPos)
                                .attr("y", height+14)
                                .attr("fill", "#000000")
                                .text(dayText);
                        };

                        function wurstStart(_) {
                            focus.select("#Y").attr("opacity", 0);
                            dates.selectAll("text").remove();
                            bars.selectAll("rect")
                                .call(wurstOpaciter, 1)
                                .call(pook)
                        };

                        function focusMove(v) {
                            focus.transition()
                                .duration(NFS)
                                .attr("transform", 
                                        "translate(" + margin.left + ",-" + H*v + ")");
                        };

                        function jump([leftDate, v]) {
                            if (v==0) {
                                showY = 1;
                            } else {
                                showY = 0;
                            };
                            cleaned(leftDate);
                            focusMove(v);
                        }

                        function cleaned(leftDate) {
                            var s = Array(leftDate, xMax);

                            bandWidth = width/data.filter(function(d) { return d.date > leftDate;}).length;
                            x.domain(s);

                            focus.selectAll("rect").call(cleaner);
                            focus.select("#X").call(resizeAx, x);
                            focus.selectAll(".move").call(mover);

                        };

                        function getDateStrFromId(i) {
                            return i.slice(1, i.length);
                        };

                        // Transitions

                        function mover(path) {
                            path
                                .transition("mover")
                                .duration(NFS)
                                .attr("x", function() { 
                                    return x(parseTime(getDateStrFromId(this.id)));
                                });
                        };

                        function cleaner(path) {
                            path
                                .transition("cleaner")
                                .duration(NFS)
                                .attr("width", bandWidth)
                                .attr("x", function(d) { return x(d.date); });
                        };

                        function resizeAx(path, a) {
                            path
                                .transition("resizeAx")
                                .duration(NFS)
                                .call(d3.axisBottom(a).tickSize(0));
                        }

                        function wurstOpaciter(path, v) {
                            path
                                .transition("wurstOpaciter")
                                .duration(NFS)
                                .attr("opacity", v);
                        }

                        function pik(path) {
                            path
                                .transition("pik")
                                .duration(NFS)
                                .attr("height", function(d) { return d.weeksum*yScaler; })
                                .attr("y", function(d) { return height-d.weeksum*yScaler; });
                        };

                        function pook(path) {
                            path
                                .transition("pook")
                                .duration(NFS)
                                .attr("height", wurstH)
                                .attr("y", height-wurstH);
                        };

                        // Scroll actions

                        let activationFunctions = [
                            [wurstStart, ""],
                            [getReal, "e1"],
                            [wurstStart, ""],
                            [getReal, "e2"],
                            [wurstStart, ""],
                            [jump, [xMin, 0.25]],
                            [jump, [cleanDate, 0]],
                            [wurstStart, ""],
                            [getReal, "e3"],
                            [wurstStart, ""],
                            [getReal, "e4"],
                            [wurstStart, ""]

                        ];
                    
                    });

                </script>
        </div>
        
    </div>
</body>
