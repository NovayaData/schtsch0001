<head>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style> body { margin: 0; } </style>
    <link rel="preconnect" href="https://fonts.gstatic.com">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Lora&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
    <script src="https://d3js.org/d3.v6.min.js"></script>
</head>
<body>
    <!-- bgcolor="#f7f7f7" -->
    <!-- style="overflow: hidden;" -->

    <div id="headers">
        <h1 class="header1">Хронология наблюдений ОБСЕ</h1>
    </div>

    <div id="graphic">

        <div id="paragraphs">
        </div>

        <div id="sections">
            <section class="step">1</section>
            <section class="step">2</section>
            <section class="step">3</section>
            <section class="step">4</section>
            <section class="step">5</section>
            <section class="step">6</section>
            <section class="step">7</section>
            <section class="step">8</section>
            <section class="step">9</section>
            <section class="step">10</section>
            <section class="step">11</section>
        </div>

        <div id="chartArea" >
            <script>

                function scroller(){
                    let container = d3.select('body')
                    let dispatch = d3.dispatch('active', 'progress');
                    let sections = d3.selectAll('.step')
                    let sectionPositions
                    let currentIndex = -1
                    let containerStart = 0;

                    function scroll(){
                        d3.select(window)
                        .on('scroll.scroller', position)
                        .on('resize.scroller', resize)
                        resize();
                        let timer = d3.timer(function() {
                        position();
                        timer.stop();
                        });
                    }

                    function resize(){
                        sectionPositions = [];
                        let startPos;
                        sections.each(function(d, i) {
                            let top = this.getBoundingClientRect().top;

                            if (i === 0 ){
                                startPos = top;
                            }

                            sectionPositions.push(top - startPos);
                        });
                    }

                    function position() {
                        let pos = window.pageYOffset - 300 - containerStart;
                        let sectionIndex = d3.bisect(sectionPositions, pos);
                        sectionIndex = Math.min(sections.size()-1, sectionIndex);
                        if (currentIndex !== sectionIndex){
                        dispatch.call('active', this, sectionIndex);
                        currentIndex = sectionIndex;
                        }
                        let prevIndex = Math.max(sectionIndex - 1, 0);
                        let prevTop = sectionPositions[prevIndex]
                        let progress = (pos - prevTop) / (sectionPositions[sectionIndex]   - prevTop);
                        dispatch.call('progress', this, currentIndex, progress)
                    }

                    scroll.container = function(value) {
                        if (arguments.legth === 0){
                        return container
                        }
                        container = value
                        return scroll
                    }
                    scroll.on = function(action, callback){
                        dispatch.on(action, callback)
                    };
                    return scroll;
                };

                function getColor(v) {
                    if (279.4>v && v>=0){
                        return "#ffed26"
                    } else if (2695.8>v && v>=279.4){
                        return "#fbbf00"
                    } else if (5163>v && v>=2695.8){
                        return "#ee9100"
                    } else if (7207.2>v && v>=5163){
                        return "#da6513"
                    } else if (v>=7207.2){
                        return "#bf381d"
                    }
                }

                function getColorG(v) {
                    if (279.4>v && v>=0){
                        return "#ececec"
                    } else if (2695.8>v && v>=279.4){
                        return "#cfcfcf"
                    } else if (5163>v && v>=2695.8){
                        return "#b0b0b0"
                    } else if (7207.2>v && v>=5163){
                        return "#949494"
                    } else if (v>=7207.2){
                        return "#787878"
                    }
                }

                const W = document.getElementById('chartArea').clientWidth,
                    H = document.getElementById('chartArea').clientHeight,
                    margin = {top: H*0.06, right: W*0.06, bottom: H*0.06, left: W*0.06},
                    width = W - margin.left - margin.right,
                    height = H - margin.top - margin.bottom;

                var svg = d3.select("#chartArea").append("svg")
                    .attr("width", W)
                    .attr("height", H)
                    .append("g")
                        

                svg.append("defs").append("clipPath")
                        .attr("id", "clip")
                    .append("rect")
                        .attr("width", width)
                        .attr("height", H);

                var focusCenter = -height/6;
                var curFocusPosition = 0;

                var focus = svg.append("g")
                    .attr("class", "focus")
                    .attr("width", width)
                    .attr("height", height)
                    .attr("transform", 
                            "translate(" + margin.left + "," + margin.top + ")");

                var parseTime = d3.timeParse("%Y-%m-%d");
                var bandWidth;

                var wurstH = H*0.035;
                var NFS = 250;

                // var sizeCondition = 0;
                var cleanDate = parseTime("2016-01-01");

                Promise.all([
                    d3.csv("../data/Scroll0001/osce_violations_Ukraine.csv"),
                    d3.json('../data/Scroll0001/article_script.json')
                ]).then(([data, articleScript]) => {

                    let activationFunctions = [
                        [dropAll, ["p1", "real", "black"]],
                        [dropAll, ["p2", "real", "colored"]],
                        [dropAll, ["p3", "wurst", ""]],
                        [getAction, ["e1", "p4", [], ["m2"]]],
                        [getAction, ["e2", "p5", ["m2"], []]],
                        [getAction, ["e5", "p5", [], []]],
                        [getSize, ["clean", "p6", 0, []]],
                        [getSize, ["clean", "p6", 1, ["m1"]]],
                        [getAction, ["e3", "p7", ["m1"], []]],
                        [getAction, ["e4", "p7", [], []]],
                        [dropAll, ["pEnd", "wurst", ""]]
                    ];

                    // Finish page

                    const paragraphs = d3.select("#paragraphs");
                    // const sections = d3.select("#sections");

                    Object.keys(articleScript.paragraphs).forEach(
                        function(p) {
                            paragraphs
                                .append("span")
                                .attr("id", "f"+p)
                                .style("opacity", 0)
                                .attr("class", "paragraphFalseText")
                                .html(articleScript.paragraphs[p]);
                            paragraphs
                                .append("span")
                                .attr("id", p)
                                .style("opacity", 0)
                                .attr("class", "paragraphText")
                                .html(articleScript.paragraphs[p]);
                        }
                    );

                    var curParagraph = "p1";
                    getText(curParagraph);

                    var navigatorX = activationFunctions.map(
                        d => { return margin.bottom + height / (activationFunctions.length - 1) * activationFunctions.indexOf(d) }
                    );

                    var circlesContainer = svg.append("g");
                    var hTr = W-margin.right/2;

                    function addCircle(i, hPos, color) {
                        

                        circlesContainer
                            .append("circle")
                            .attr("id", "c"+i)
                            .attr("r", "4px")
                            .attr("fill", color)
                            .attr("transform", 
                                "translate(" + hTr + "," + hPos + ")");
                    };

                    navigatorX.forEach(
                        function(d, i) {
                            addCircle(i, d, "#ececec")
                        }
                    );

                    addCircle("theCircle", navigatorX[0], "#b0b0b0");
                    const theCircle = circlesContainer.select("#ctheCircle");

                    
                    d3.selectAll(".step:last-of-type").style("margin-bottom","50vh");

                    // Transform data

                    var marksData = {};

                    data.forEach(d => {
                        d.dateStr = d.date;
                        d.date = parseTime(d.date);
                        d.episode = "episode ";

                        marksData[d.dateStr] = [d.weeksum, d.date];

                        Object.keys(articleScript.episodes).forEach( function(eKey) {

                            let eList = articleScript.episodes[eKey];
                            eList.forEach(function(e) {

                                let minDate = parseTime(e[0]),
                                    maxDate = parseTime(e[1]);

                                if (d.date >= minDate && d.date <= maxDate) {
                                    d.episode += eKey+" ";
                                }
                            })
                        });

                    });

                    // Draw

                    var xMin = d3.min(data, function(d) { return d.date; });
                    var xMax = d3.max(data, function(d) { return d.date; });

                    weeksumMax = d3.max(data, function(d) { return parseInt(d.weeksum); });
                    yScaler = (H*0.7)/weeksumMax;

                    Math.round(weeksumMax/10000)*10000

                    var x = d3.scaleTime()
                        .range([0, width]);

                    var y = d3.scaleLinear()
                        .range([height, height-Math.round(weeksumMax/10000)*10000*yScaler]);

                    x.domain([xMin, xMax]);

                    function addXAx(i, o, h, t, f) {
                        focus.append("g")
                            .attr("clip-path", "url(#clip)")
                            .attr("id", i)
                            .attr("opacity", o)
                            .attr("transform", "translate(0," + h + ")")
                            .call(
                                d3.axisBottom(x)
                                    .tickSize(0)
                                    .ticks(t)
                                    .tickFormat(f)
                                )
                            .selectAll("text")
                                .attr('text-anchor', 'start')
                                .attr("class", "textSmaller");
                    };
                    
                    addXAx("Xmonths", 0, height+5, d3.timeMonth, d3.timeFormat("%-m"));
                    addXAx("X", 1, height+20, d3.timeYear, d3.timeFormat("| %Y"));

                    y.domain([0, 40000]);
                    focus.append("g")
                        .attr("id", "Y")
                        .attr("opacity", 1)
                        .call(d3.axisLeft(y)
                            .tickSize(0)
                            .tickFormat(d => { return d3.format(",.0f")(d).replace(",", ' ') } ))
                        .selectAll("text")
                            .attr('text-anchor', 'end')
                            .attr("class", "textSmaller");

                    function dropDomains() {
                        focus.selectAll(".domain")
                            .remove()
                    };

                    dropDomains();

                    var bars = focus.append("g");
                    bandWidth = width/data.length+0.4;

                    bars.attr("clip-path", "url(#clip)");
                    bars.selectAll("bar")
                    .data(data)
                    .enter().append("rect")
                        .attr("class", function(d) { return d.episode; })
                        .attr("fill", "#494a4d")
                        .attr("id", function(d) { return "b"+d.dateStr; })
                        .attr("x", function(d) { return x(d.date); })
                        .attr("width", bandWidth)
                        .attr("height", function(d) { return d.weeksum*yScaler})
                        .attr("y", function(d) { return y(d.weeksum); })
                        .attr("opacity", 1);

                    function colorise(date, value) {
                        if (date < cleanDate) {
                            return getColorG(value);
                        } else {
                            return getColor(value);
                        }
                    };

                    const marks = focus.append("g");
                    marks.attr("clip-path", "url(#clip)");

                    Object.keys(articleScript.marks).forEach(
                        function(m) {
                            let mList =  articleScript.marks[m];
                            mList.forEach(
                                function(mark) {
                                    let markWidth = x(marksData[mark[0]][1])+bandWidth/2;
                                    marks.append("circle")
                                        .attr("id", "m"+mark[0])
                                        .attr("class", "mark "+m)
                                        .attr("r", bandWidth*2)
                                        .attr("fill", "#00ace5")
                                        .attr("opacity", 0)
                                        .attr("text", mark[1])
                                        .attr("cx", markWidth)
                                        .attr("cy", height-wurstH-10);
                                        // .attr("cy", y(marksData[mark[0]][0])-10);
                                }
                            )
                        }
                    );

                    function getFormatedDate(date) {
                        date = parseTime(date);
                        let mo = new Intl.DateTimeFormat('ru', { month: 'short' }).format(date);
                        let da = new Intl.DateTimeFormat('ru', { day: 'numeric' }).format(date);
                        return `${da} ${mo}`;
                    };

                    // Actions

                    function paintCircle(i) {
                        circlesContainer.select("circle").filter()
                    };

                    function marker(mids, mode) {
                        if (mids) {
                            mids.forEach(
                                function(mid) {
                                    let curMarks = marks.select("."+mid)
                                    curMarks.call(markOn, mode);
                                    // if (mode=="on") {
                                    //     curMarks.call(wurstOpaciter, 1);;
                                    // } else if (mode=="off") {
                                    //     curMarks.call(wurstOpaciter, 0)
                                    // };
                                }
                            ) 
                        }
                    };

                    function markOn(path, mode) {
                        path
                            .attr("opacity", function(d) {
                                if (mode=="on") {
                                    return 1;
                                } else if (mode=="off") {
                                    return 0;
                                } else {
                                    alert("what??" + " " + curClass + " " + mode)
                                }
                            })
                            .attr("class", function() {

                                let curClass = this.getAttribute("class");

                                if (!curClass.includes("on") && mode=="on") {
                                    return curClass.replace("mark", "mark on");
                                } else if (curClass.includes("on") && mode=="on") {
                                    return curClass;
                                } else if (mode=="off") {
                                    return curClass.replace("mark on", "mark");
                                } else {
                                    alert("what?" + " " + curClass + " " + mode)
                                }
                            });
                            
                    }

                    function getAction(args) {

                        let eid = args[0],
                            pid = args[1],
                            mids = args[2],
                            midsDel = args[3];

                        marker(mids, "on");
                        marker(midsDel, "off");

                        if (eid && eid!="clean") {
                            getReal(eid, "colored")
                        } else if (eid=="clean") {
                            getWurst();
                        };

                        if (pid && pid!="clean") {
                            getText(pid)
                        } else if (pid=="clean") {
                            getBlanc();
                        };

                    };

                    function getReal(eid, colorMode) {
                        bars.selectAll("rect").filter(function() {
                                return !this.classList.contains(eid)
                            }).call(wurstOpaciter, 0.5).call(pookColor).call(pook)

                            let curReal = focus.selectAll("."+eid)

                            curReal.call(wurstOpaciter, 1).call(pik).call(pikColor, colorMode);

                            let curMarksIds = curReal.nodes().map(function(d) { return d.id.replace("b", "m")  });
                            if (curMarksIds) {
                                marks.selectAll(".on").filter( function() { return curMarksIds.includes(this.id) } )
                                    .call(pikMark);
                                marks.selectAll(".on").filter( function() { return !curMarksIds.includes(this.id) } )
                                    .call(pookMark, 0.5);
                            };

                            marks.selectAll("circle:not(.on)").call(pookMark, 0);

                            focus.select("#Xmonths").attr("opacity", 1);
                            focus.select("#Y").attr("opacity", 1);
                    };

                    function getSize(args) {
                        let eid = args[0],
                            pid = args[1],
                            sizeCondition = args[2],
                            midsDel = args[3];

                        marker(midsDel, "off");
                        marks.selectAll("circle:not(.on)").call(pookMark, 0);

                        if (eid=="clean") {
                            getWurst()
                        };

                        if (sizeCondition==1) {
                            resizer(cleanDate);
                        } else {
                            resizer(xMin);
                        };

                        getText(pid);
                    };

                    function getText(pid) {
                        d3.selectAll(".paragraphFalseText").filter(function() {
                            return this.id != "f"+pid
                        }).call(textOpaciter, 0);
                        d3.select("#f"+pid).call(textOpaciter, 0.8);

                        d3.selectAll(".paragraphText").filter(function() {
                            return this.id != pid
                        }).call(textOpaciter, 0);
                        d3.select("#"+pid).call(textOpaciter, 1);
                    };

                    function textMover(path) {
                        path
                            .transition("textMover")
                            .duration(NFS*2)
                            .style("margin-top", 
                                 "9%");
                    };

                    function textOpaciter(path, o) {
                        path
                            .transition("textOpaciter")
                            .duration(NFS)
                            .style("opacity", o);
                    }

                    function getWurst() {
                        focus.select("#Y").attr("opacity", 0);
                        focus.select("#Xmonths").attr("opacity", 0);

                        bars.selectAll("rect")
                            .call(wurstOpaciter, 1)
                            .call(pookColor)
                            .call(pook)

                        marks.selectAll(".on").call(pookMark, 1);
                    };

                    function getBlanc() {
                        d3.selectAll(".paragraphText").call(textOpaciter, 0);
                    };

                    function dropAll(args) {
                        let pid = args[0],
                            barType = args[1],
                            colorMode = args[2];

                        if (barType=="wurst") {
                            getWurst();
                        } else if (barType=="real") {
                            getReal("episode", colorMode);
                        };
                        
                        getText(pid);
                    };

                    function resizer(leftDate) {

                        var s = Array(leftDate, xMax);

                        bandWidth = width/data.filter(function(d) { return d.date > leftDate;}).length+0.4;
                        x.domain(s);

                        focus.selectAll("rect").call(resizeBars);
                        focus.select("#X").call(resizeAx, x, d3.timeYear, "| %Y");
                        focus.select("#Xmonths").call(resizeAx, x, d3.timeMonth, "%-m");
                        focus.selectAll(".mark").call(resizeMarks);
                        dropDomains();

                    };

                    // Transitions
                    
                    function resizeMarks(path) {
                        path
                            .transition("resizeBars")
                            .duration(NFS)
                            .attr("cx", 
                                function() {
                                    return x(marksData[this.id.replace("m", "")][1])+bandWidth/2
                                });
                    }

                    function resizeBars(path) {
                        path
                            .transition("resizeBars")
                            .duration(NFS)
                            .attr("width", bandWidth)
                            .attr("x", function(d) { return x(d.date); });
                    };

                    function resizeAx(path, a, t, f) {
                        path
                            .transition("resizeAx")
                            .duration(NFS)
                            .call(d3.axisBottom(a)
                                .tickSize(0)
                                .ticks(t)
                                .tickFormat(d3.timeFormat(f))
                            )
                        .selectAll("text")
                            .attr('text-anchor', 'start')
                            .attr("class", "textSmaller");
                    }

                    function wurstOpaciter(path, v) {
                        path
                            .transition("wurstOpaciter")
                            .duration(NFS)
                            .attr("opacity", v);
                    };

                    function pik(path) {
                        path
                            .transition("pik")
                            .duration(NFS)
                            .attr("height", function(d) { 
                                return d.weeksum*yScaler;
                            })
                            .attr("y", function(d) { return y(d.weeksum); });
                    };

                    function pikMark(path) {
                        
                        path
                            .transition("pikMark")
                            .duration(NFS)
                            .attr("cy", 
                                function() {
                                    return y(marksData[this.id.replace("m", "")][0])-10
                                }
                            )
                            .attr("opacity", 1);
                        };

                    function pikColor(path, colorMode) {
                        path
                            .transition("pikColor")
                            .duration(NFS)
                            .attr("fill", function(d) {

                                if (colorMode == "black") {
                                    return "#494a4d"
                                } else if (colorMode == "colored") {
                                    return colorise(d.date, d.weeksum)
                                }

                            });
                    };

                    function pook(path) {
                        path
                            .transition("pook")
                            .duration(NFS)
                            .attr("height", wurstH)
                            .attr("y", height-wurstH);
                    };

                    function pookColor(path) {
                        path
                            .transition("pookColor")
                            .duration(NFS)
                            .attr("fill", function(d) { return colorise(d.date, d.weeksum) });
                    };

                    function pookMark(path, o) {
                        path
                            .transition("pookColor")
                            .duration(NFS)
                            .attr("cy", height-wurstH-10)
                            .attr("opacity", o);
                    }

                    function navigate(path, i) {
                        path
                            .transition("navigate")
                            .duration(NFS)
                            .attr("transform", 
                                "translate(" + hTr + "," + navigatorX[i] + ")")
                    };

                    // Scroll

                    let scroll = scroller().container(d3.select('#graphic'));
                        scroll();
                    let lastIndex, activeIndex = 0;

                    scroll.on('active', function(index){
                        // d3.selectAll('.step')
                        //     .transition().duration(0)
                        //     .style('opacity', function (d, i) {return i === index ? 1 : 0;});

                        activeIndex = index
                        let sign = (activeIndex - lastIndex) < 0 ? -1 : 1;
                        let scrolledSections = d3.range(lastIndex + sign, activeIndex + sign, sign);

                        scrolledSections.forEach(i => {
                            activationFunctions[i][0](
                                activationFunctions[i][1]
                                // activationFunctions[i][2]
                            );
                            theCircle.call(navigate, i);
                        })
                        lastIndex = activeIndex;
                    });
                });

            </script>
        </div>
    </div>
</body>
