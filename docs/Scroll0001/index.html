<head>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style> body { margin: 0; } </style>
    <link rel="preconnect" href="https://fonts.gstatic.com">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Lora&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
    <script src="https://d3js.org/d3.v6.min.js"></script>
</head>
<body>
    <div id="headers">
        <h1 class="header1">Хронология наблюдений ОБСЕ</h1>
    </div>

    <div id="graphic">

        <div id="sections">
        </div>

        <div id="chartArea" >
            <script>

                function scroller(){
                    let container = d3.select('body')
                    let dispatch = d3.dispatch('active', 'progress');
                    let sections = d3.selectAll('.step')
                    let sectionPositions
                    let currentIndex = -1
                    let containerStart = 0;

                    function scroll(){
                        d3.select(window)
                        .on('scroll.scroller', position)
                        .on('resize.scroller', resize)
                        resize();
                        let timer = d3.timer(function() {
                        position();
                        timer.stop();
                        });
                    }

                    function resize(){
                        sectionPositions = [];
                        let startPos;
                        sections.each(function(d, i) {
                            let top = this.getBoundingClientRect().top;

                            if (i === 0 ){
                                startPos = top;
                            }

                            sectionPositions.push(top - startPos);
                        });
                    }

                    function position() {
                        let pos = window.pageYOffset - 300 - containerStart;
                        let sectionIndex = d3.bisect(sectionPositions, pos);
                        sectionIndex = Math.min(sections.size()-1, sectionIndex);
                        if (currentIndex !== sectionIndex){
                        dispatch.call('active', this, sectionIndex);
                        currentIndex = sectionIndex;
                        }
                        let prevIndex = Math.max(sectionIndex - 1, 0);
                        let prevTop = sectionPositions[prevIndex]
                        let progress = (pos - prevTop) / (sectionPositions[sectionIndex]   - prevTop);
                        dispatch.call('progress', this, currentIndex, progress)
                    }

                    scroll.container = function(value) {
                        if (arguments.legth === 0){
                        return container
                        }
                        container = value
                        return scroll
                    }
                    scroll.on = function(action, callback){
                        dispatch.on(action, callback)
                    };
                    return scroll;
                };

                var colorSteps = [279.4, 2695.8, 5163, 7207.2];

                function getColor(v) {
                    if (colorSteps[0]>v && v>=0){
                        return "#ffed26"
                    } else if (colorSteps[1]>v && v>=colorSteps[0]){
                        return "#fbbf00"
                    } else if (colorSteps[2]>v && v>=colorSteps[1]){
                        return "#ee9100"
                    } else if (colorSteps[3]>v && v>=colorSteps[2]){
                        return "#da6513"
                    } else if (v>=colorSteps[3]){
                        return "#bf381d"
                    }
                }

                // function getColor(v) {
                //     if (colorSteps[0]>v && v>=0){
                //         return "#ffed26"
                //     } else if (colorSteps[1]>v && v>=colorSteps[0]){
                //         return "#ffc300"
                //     } else if (colorSteps[2]>v && v>=colorSteps[1]){
                //         return "#ff9800"
                //     } else if (colorSteps[3]>v && v>=colorSteps[2]){
                //         return "#f56b03"
                //     } else if (v>=colorSteps[3]){
                //         return "#e5381d"
                //     }
                // }

                function getColorG(v) {
                    if (colorSteps[0]>v && v>=0){
                        return "#ececec"
                    } else if (colorSteps[1]>v && v>=colorSteps[0]){
                        return "#cfcfcf"
                    } else if (colorSteps[2]>v && v>=colorSteps[1]){
                        return "#b0b0b0"
                    } else if (colorSteps[3]>v && v>=colorSteps[2]){
                        return "#949494"
                    } else if (v>=colorSteps[3]){
                        return "#787878"
                    }
                }

                const W = document.getElementById('chartArea').clientWidth,
                    H = document.getElementById('chartArea').clientHeight,
                    margin = {top: H*0.06, right: W*0.06, bottom: H*0.06, left: W*0.06},
                    width = W - margin.left - margin.right,
                    height = H - margin.top - margin.bottom;

                var svg = d3.select("#chartArea").append("svg")
                    .attr("width", W)
                    .attr("height", H)
                    .append("g")
                        

                svg.append("defs").append("clipPath")
                        .attr("id", "clip")
                    .append("rect")
                        .attr("width", width)
                        .attr("height", H);

                var focusCenter = -height/6;
                var curFocusPosition = 0;

                var focus = svg.append("g")
                    .attr("class", "focus")
                    .attr("width", width)
                    .attr("height", height)
                    .attr("transform", 
                            "translate(" + margin.left + "," + margin.top + ")");

                var parseTime = d3.timeParse("%Y-%m-%d");
                var bandWidth;

                // var wurstH = H*0.02;
                var wurstH = H*0.035;
                var NFS = 400;

                // var sizeCondition = 0;
                var cleanDate = parseTime("2016-01-01");

                Promise.all([
                    d3.csv("../data/Scroll0001/osce_violations_Ukraine.csv"),
                    d3.json('../data/Scroll0001/article_script.json'),
                    d3.csv("../data/Scroll0001/google_search_index_Donbas.csv")
                ]).then(([data, articleScript, googleData]) => {

                    // const sections = d3.select("#sections");
                    // var activationFunctions = [];

                    // const actionsDict = {
                    //     "dropAll":dropAll,
                    //     "getSize":getSize,
                    //     "getAction":getAction
                    // };

                    // Object.keys(articleScript.paragraphs).forEach(
                    //     function(p, i) {
                    //         let abz = articleScript.paragraphs[p][1];

                    //         activationFunctions.push(articleScript.paragraphs[p][0]);

                    //         i+=1
                    //         let curSection = sections.append("section")
                    //             .attr("class", "step")
                    //             .attr("id", p+"_"+i);
                            
                    //         curSection
                    //             .append("span")
                    //             .attr("class", "paragraphFalseText")
                    //             .html(a);
                            
                    //         curSection
                    //             .append("span")
                    //             .attr("class", "paragraphText")
                    //             .html(a);

                    //         } )
                    //     }
                    // );

                    const activationFunctions = [
                                [dropAll, ["zero", ""]],
                                [dropAll, ["zero", ""]],
                                [dropAll, ["real", "black"]],
                                [dropAll, ["real", "colored"]],
                                [dropAll, ["wurst", ""]],
                            [getSize, ["clean", 0, []]],
                            [getSize, ["clean", 1, []]],
                        [getAction, ["e1", [], []]],
                        [getAction, ["e1", [], []]],
                        [getAction, ["e1", [], []]],
                        [getAction, ["e1", [], []]],
                        [getAction, ["e2", [], []]],
                        [getAction, ["e2", [], []]],
                        [getAction, ["e2", [], []]],
                        [getAction, ["e3", [], []]],
                        [getAction, ["e3", [], []]],
                                [dropAll, ["wurst", ""]],
                                [dropAll, ["wurst", ""]],
                                [dropAll, ["wurst", ""]],
                                [dropAll, ["wurst", ""]],
                        [getAction, ["e4", [], []]],
                        [getAction, ["e4", [], []]],
                        [getAction, ["e5", [], []]],
                                [dropAll, ["wurst", ""]],
                        [getAction, ["e6", [], []]],
                        [getAction, ["e6", [], []]],
                        [getAction, ["e6", [], []]],
                                [dropAll, ["wurst", ""]],
                                [dropAll, ["wurst", ""]],
                        [getAction, ["e7", [], []]],
                        [getAction, ["e7", [], []]],
                                [dropAll, ["wurst", ""]],
                        [getAction, ["e8", [], []]],
                        [getAction, ["e8", [], []]],
                        [getAction, ["e8", [], []]],
                        [getAction, ["e8", [], []]],
                        [getAction, ["e8", [], []]],
                        [getAction, ["e8", [], []]],
                        [getAction, ["e9", [], []]],
                        [getAction, ["e9", [], []]],
                        [getAction, ["e9", [], []]],
                        [getAction, ["e9", [], []]],
                                [dropAll, ["wurst", ""]],
                                [dropAll, ["wurst", ""]],
                        [getAction, ["e8", [], []]],
                        [getAction, ["e8", [], []]],
                        [getAction, ["e8", [], []]],
                        [getAction, ["e8", [], []]],
                        [getAction, ["e10", [], []]],
                        [getAction, ["e10", [], []]],
                                [dropAll, ["wurst", ""]],
                                [dropAll, ["wurst", ""]],
                                [dropAll, ["wurst", ""]],
                                [dropAll, ["wurst", ""]],
                                [dropAll, ["wurst", ""]],
                                [dropAll, ["real", "black"]]
                    ];

                    // Finish page
                    const sections = d3.select("#sections");

                    Object.keys(articleScript.paragraphs).forEach(
                        function(p) {
                            let abz = articleScript.paragraphs[p];
                            
                            abz.forEach( function(a, i) {
                                i+=1
                                let curSection = sections.append("section")
                                    .attr("class", "step")
                                    .attr("id", p+"_"+i);

                                curSection
                                    .append("span")
                                    .attr("class", "paragraph paragraphFalseText")
                                    .html(a);
                                
                                curSection
                                    .append("span")
                                    .attr("class", "paragraph paragraphText")
                                    .html(a);
                            } )
                        }
                    );

                    // Transform data

                    var marksData = {};
                    data.forEach(d => {
                        d.dateStr = d.date;
                        d.date = parseTime(d.date);
                        d.episode = "episode ";

                        marksData[d.dateStr] = [d.weeksum, d.date];

                        Object.keys(articleScript.episodes).forEach( function(eKey) {

                            let eList = articleScript.episodes[eKey];

                            eList.forEach(function(e) {

                                let minDate = parseTime(e[0]),
                                    maxDate = parseTime(e[1]);

                                if (d.date >= minDate && d.date <= maxDate) {
                                    d.episode += eKey+" ";
                                };

                            })
                        });

                    });

                    var fakeBars = [];
                    
                    Object.keys(articleScript.episodes).forEach( function(eKey) {

                        let eList = articleScript.episodes[eKey];

                        eList.forEach(function(e) {
                            let minDate = parseTime(e[0]),
                                maxDate = parseTime(e[1]);

                            fakeBars.push([eKey, minDate, maxDate])
                        })
                    });

                    googleData.forEach(d => {
                        d.date = parseTime(d.date),
                        d.search_index = parseFloat(d.search_index)
                    });

                    // Draw

                    var xMin = d3.min(data, function(d) { return d.date; });
                    var xMax = d3.max(data, function(d) { return d.date; });

                    var weeksumMax = d3.max(data, function(d) { return parseInt(d.weeksum); });
                    // var yScaler = (H*0.4)/weeksumMax;
                    var yScaler = (H*0.75)/weeksumMax;

                    var bandWidth = width/data.length+0.4;

                    Math.round(weeksumMax/10000)*10000

                    var x = d3.scaleTime()
                        .range([0, width]);

                    var y = d3.scaleLinear()
                        .range([height, height-Math.round(weeksumMax/10000)*10000*yScaler]);

                    var y2 = d3.scaleLinear()
                        .range([height, height-Math.round(weeksumMax/10000)*10000*yScaler]);

                    x.domain([xMin, xMax]);

                    function addXAx(i, o, h, t, f, ts) {
                        focus.append("g")
                            .attr("clip-path", "url(#clip)")
                            .attr("id", i)
                            .attr("opacity", o)
                            .attr("transform", "translate(0," + h + ")")
                            .call(
                                d3.axisBottom(x)
                                    .tickSize(ts)
                                    .ticks( t )
                                    .tickFormat(f)
                                )
                            .selectAll("text")
                                .attr('text-anchor', 'start')
                                .attr("class", "textSmaller");
                    };
                    
                    addXAx("Xmonths", 1, height+5, d3.timeMonth, d3.timeFormat("%-"), 5);
                    addXAx("Xseasons", 1, height+5, d3.timeMonth.every(3), d3.timeFormat("%b"), 10);
                    addXAx("X", 1, height+25, d3.timeYear, d3.timeFormat("%Y"), 0);

                    var y2x = bandWidth*2+width;

                    function addY(aY, domainR, tranlateX, textClass, i, anc) {
                        aY.domain([0, domainR]);
                        focus.append("g")
                            .attr("id", i)
                            .attr("opacity", 1)
                            .attr("transform", "translate("+tranlateX+",0)")
                            .call(d3.axisLeft(aY)
                                .tickSize(0)
                                .tickFormat(d => {  
                                    if (H<W) {
                                        return d3.format(",.0f")(d).replace(",", "\xa0");
                                    } else {
                                        return d3.format(",.0f")(d).replace(",000", 'k');
                                    }
                                } ))
                            .selectAll("text")
                                .attr('text-anchor', anc)
                                .attr("class", textClass);
                    };

                    addY(y, 40000, 0, "textSmaller2", "Y", "end");
                    addY(y2, 100, y2x, "textSmaller", "Y2", "start");
                    focus.select("#Y").attr("opacity", 0);

                    function dropDomains() {
                        focus.selectAll(".domain")
                            .remove()
                    };

                    dropDomains();

                    var barsFake = focus.append("g");
                    barsFake.attr("clip-path", "url(#clip)");

                    fakeBars.forEach( function(fb) {
                        barsFake.append("rect")
                            .attr("class", fb[0])
                            .attr("fill", "#f7f7f7")
                            // .attr("id", function(d) { return iPref+d.dateStr; })
                            .attr("x", x(fb[1]))
                            .attr("width", x(fb[2])-x(fb[1])+bandWidth)
                            .attr("height", H-(H-y(0)))
                            .attr("y", 0)
                            // .attr("height", 40000*yScaler)
                            // .attr("y", y(40000))
                            .attr("opacity", 0);
                    });

                    var bars = focus.append("g");
                    
                    function addBars(group, color, iPref, cSuf, defaultH, o) {
                        group.attr("clip-path", "url(#clip)");
                        group.selectAll("bar")
                        .data(data)
                        .enter().append("rect")
                            .attr("class", function(d) { return d.episode + cSuf; })
                            .attr("fill", color)
                            .attr("id", function(d) { return iPref+d.dateStr; })
                            .attr("x", function(d) { return x(d.date); })
                            .attr("width", bandWidth)
                            .attr("height", defaultH*yScaler)
                            .attr("y", y(defaultH))
                            // .attr("height", function(d) { return d.weeksum*yScaler})
                            // .attr("y", function(d) { return y(d.weeksum); })
                            .attr("opacity", o);
                    };

                    // addBars(barsFake, "#f0f1f2", "bf", " fake", 40000, 0);
                    addBars(bars, "#494a4d", "b", " wurst", 0, 1);

                    function colorise(date, value) {
                        if (date < cleanDate) {
                            return getColorG(value);
                        } else {
                            return getColor(value);
                        }
                    };

                    function addLine(color, lineWidth) {
                        focus.append("g").attr("clip-path", "url(#clip)")
                        .append("path")
                        .datum(googleData)
                        .attr("fill", "none")
                        .attr("opacity", 1)
                        .attr("stroke-width", lineWidth)
                        .attr("stroke", color)
                        .attr("stroke-linejoin", "round")
                        .attr("stroke-linecap", "round")
                        .attr(
                            "d", 
                            d3.line()
                            .curve(d3.curveCatmullRom)
                            .x(d => x(d.date))
                            .y(d => y(d.search_index*40000))
                        );
                    }

                    addLine("#ffffff", bandWidth*2);
                    addLine("#212226", bandWidth/2);

                    const marks = focus.append("g");
                    marks.attr("clip-path", "url(#clip)");

                    Object.keys(articleScript.marks).forEach(
                        function(m) {
                            let mList =  articleScript.marks[m];
                            mList.forEach(
                                function(mark) {
                                    let markWidth = x(marksData[mark[0]][1])+bandWidth/2;
                                    marks.append("circle")
                                        .attr("id", "m"+mark[0])
                                        .attr("class", "mark "+m)
                                        .attr("r", bandWidth*1.5)
                                        .attr("fill", "#f7f7f7")
                                        .attr("opacity", 0)
                                        .attr("text", mark[1])
                                        .attr("cx", markWidth)
                                        .attr("cy", height-wurstH-10);
                                }
                            )
                        }
                    );

                    function getFormatedDate(date) {
                        date = parseTime(date);
                        let mo = new Intl.DateTimeFormat('ru', { month: 'short' }).format(date);
                        let da = new Intl.DateTimeFormat('ru', { day: 'numeric' }).format(date);
                        return `${da} ${mo}`;
                    };

                    var navigatorX = activationFunctions.map(
                        d => { return margin.bottom + height / (activationFunctions.length - 1) * activationFunctions.indexOf(d) }
                    );

                    var circlesContainer = svg.append("g");
                    var hTr = W-margin.right/2;

                    function addCircle(i, hPos, color) {
                        circlesContainer
                            .append("circle")
                            .attr("id", function() { return "C"+i })
                            .attr("r", "4px")
                            .attr("fill", color)
                            .attr("transform", 
                                "translate(" + hTr + "," + hPos + ")");
                    };

                    var theCircle;

                    if (H<W) {
                        var sectionsNodes = d3.select("#sections").selectAll(".step").nodes()
                    
                        sectionsNodes.forEach(
                            function(d, i) {
                                addCircle(d.id, navigatorX[i], "#ececec")
                            }
                        );

                        var circlesNav = circlesContainer.selectAll("circle");
                        var circlesNavNodes = circlesNav.nodes();

                        circlesNav
                            .on("mouseover", function(d) {
                                d3.select(this).attr("fill", "#bf381d");
                        });

                        circlesNav
                            .on("mouseleave", function(d) {
                                d3.select(this).attr("fill", "#ececec");
                            });

                        circlesNav
                            .on("click", function(d) {
                                document.getElementById(this.id.replace("C", "")).scrollIntoView(
                                    {behavior: "smooth"}
                                    );
                            });

                        addCircle("theCircle", navigatorX[0], "#b0b0b0");
                        theCircle = circlesContainer.select("#CtheCircle");
                    };
                    

                    let leftB = width*0.25,
                        wid = width*0.1;

                    var colorLegend = focus.append("g")
                        .attr("id", "colorLegend")
                        .attr("opacity", 0),
                        legendSteps = [0].concat(colorSteps);

                    legendSteps.forEach(
                        function(colorValue) {
                            curG = colorLegend.append("g");
                            curG.append("rect")
                                .attr("y", 0)
                                .attr("x", leftB)
                                .attr("width", wid)
                                .attr("height", bandWidth*2)
                                .attr("fill", function() {return getColor(colorValue) });
                            curG.append("g")
                                .append("text")
                                .attr("class", "textSmaller")
                                .attr("fill", "#0f0f0f")
                                .attr("x", leftB)
                                .attr("y", bandWidth*6)
                                .attr("text-anchor", "middle")
                                .text( function() {
                                    if (colorValue==0) {
                                        return "";
                                    } else {
                                        return colorValue.toString().replace(".", ",");
                                    }
                                } );

                            leftB+=wid;
                        }
                    )
                                

                    // Actions

                    function marker(mids, mode) {
                        if (mids) {
                            mids.forEach(
                                function(mid) {
                                    let curMarks = marks.select("."+mid)
                                    curMarks.call(markOn, mode);
                                    // if (mode=="on") {
                                    //     curMarks.call(wurstOpaciter, 1);;
                                    // } else if (mode=="off") {
                                    //     curMarks.call(wurstOpaciter, 0)
                                    // };
                                }
                            ) 
                        }
                    };

                    function markOn(path, mode) {
                        path
                            .attr("opacity", function(d) {
                                if (mode=="on") {
                                    return 1;
                                } else if (mode=="off") {
                                    return 0;
                                } else {
                                    alert("what??" + " " + curClass + " " + mode)
                                }
                            })
                            .attr("class", function() {

                                let curClass = this.getAttribute("class");

                                if (!curClass.includes("on") && mode=="on") {
                                    return curClass.replace("mark", "mark on");
                                } else if (curClass.includes("on") && mode=="on") {
                                    return curClass;
                                } else if (mode=="off") {
                                    return curClass.replace("mark on", "mark");
                                } else {
                                    alert("what?" + " " + curClass + " " + mode)
                                }
                            });
                            
                    }

                    function getAction(args) {

                        let eid = args[0],
                            mids = args[1],
                            midsDel = args[2];

                        marker(mids, "on");
                        marker(midsDel, "off");

                        if (eid && eid!="clean") {
                            getReal(eid, "colored")
                        } else if (eid=="clean") {
                            getWurst();
                        };

                    };

                    // var barsAll = bars.selectAll("rect").nodes();
                    function getReal(eid, colorMode) {
                        bars.selectAll("rect").filter(function() {
                                return !this.classList.contains(eid)
                        }).call(pookColor).call(pook).call(wurstOpaciter, 0.5)

                        barsFake.selectAll("rect").filter(function() {
                                return !this.classList.contains(eid)
                        }).call(wurstOpaciter, 0)
                        barsFake.selectAll("."+eid).call(wurstOpaciter, 1)

                        let curReal = bars.selectAll("."+eid)

                        if (colorMode == "black") {
                            colorLegend.call(wurstOpaciter, 0);
                        } else {
                            colorLegend.call(wurstOpaciter, 1);
                        };


                        // let curRealNodes = curReal.nodes(),
                        //     aI = barsAll.indexOf(curRealNodes[0]),
                        //     bI = barsAll.indexOf(curRealNodes[curRealNodes.length-1]);

                        // let aDate = data[aI].date,
                        //     bDate = data[bI].date;

                        // resizer(aDate, bDate);

                        curReal.call(pik).call(pikColor, colorMode).call(wurstOpaciter, 1);

                        let curMarksIds = curReal.nodes().map(function(d) { return d.id.replace("b", "m")  });
                        if (curMarksIds) {
                            marks.selectAll(".on").filter( function() { return curMarksIds.includes(this.id) } )
                                .call(pikMark);
                            marks.selectAll(".on").filter( function() { return !curMarksIds.includes(this.id) } )
                                .call(pookMark, 0.5);
                        };

                        marks.selectAll("circle:not(.on)").call(pookMark, 0);

                        // focus.select("#Xmonths").attr("opacity", 1);
                        focus.select("#Y").attr("opacity", 1);
                    };

                    function getSize(args) {
                        let eid = args[0],
                            sizeCondition = args[1],
                            midsDel = args[2];

                        marker(midsDel, "off");
                        marks.selectAll("circle:not(.on)").call(pookMark, 0);

                        colorLegend.call(wurstOpaciter, 1);

                        if (eid=="clean") {
                            getWurst()
                        };

                        if (sizeCondition==1) {
                            resizer(cleanDate, xMax);
                        } else {
                            resizer(xMin, xMax);
                        };
                    };

                    function getWurst() {
                        focus.select("#Y").attr("opacity", 0);
                        // focus.select("#Xmonths").attr("opacity", 0);
                        barsFake.selectAll("rect").call(wurstOpaciter, 0)

                        resizer(xMin, xMax);

                        bars.selectAll(".wurst")
                            .call(wurstOpaciter, 1)
                            .call(pookColor)
                            .call(pook)

                        marks.selectAll(".on").call(pookMark, 1);
                    };

                    function getZero() {
                        focus.select("#Y").attr("opacity", 0);
                        // focus.select("#Xmonths").attr("opacity", 0);
                        barsFake.selectAll("rect").call(wurstOpaciter, 0)

                        bars.selectAll(".wurst")
                            .call(wurstOpaciter, 1)
                            // .call(pookColor)
                            .call(pookZero)

                        marks.selectAll(".on").call(pookMark, 1);
                    };

                    function dropAll(args) {
                        let barType = args[0],
                            colorMode = args[1];

                        

                        if (barType=="wurst") {
                            colorLegend.call(wurstOpaciter, 1);
                            getWurst();
                        } else if (barType=="real") {
                            getReal("wurst", colorMode);
                        } else if (barType=="zero") {
                            colorLegend.call(wurstOpaciter, 0);
                            getZero();
                        };
                        
                    };

                    function resizer(leftDate, rightDate) {

                        var s = Array(leftDate, rightDate);

                        bandWidth = width/data.filter(function(d) { return d.date > leftDate && d.date < rightDate;}).length+0.4;
                        x.domain(s);

                        bars.selectAll("rect").call(resizeBars);

                        barsFake.selectAll("rect").call(resizeFakeBars);

                        focus.selectAll("path").call(resizeLine);
                        focus.select("#X").call(resizeAx, x, d3.timeYear, "%Y", 15);
                        focus.select("#Xseasons").call(resizeAx, x, d3.timeMonth.every(3), d3.timeFormat("%-"), 10);
                        focus.select("#Xmonths").call(resizeAx, x, d3.timeMonth, "%-", 5);
                        focus.selectAll(".mark").call(resizeMarks);
                        dropDomains();

                    };

                    // Transitions
                    
                    function resizeMarks(path) {
                        path
                            .transition("resizeBars")
                            .duration(NFS)
                            .attr("cx", 
                                function() {
                                    return x(marksData[this.id.replace("m", "")][1])+bandWidth/2
                                });
                    }

                    function resizeLine(path) {
                        path
                            .transition("resizeLine")
                            .duration(NFS)
                            .attr("d", d3.line()
                                .curve(d3.curveCatmullRom)
                                .x(function(d) { return x(d.date) })
                                .y(function(d) { return y(d.search_index*40000) }))
                    };

                    function resizeBars(path) {
                        path
                            .transition("resizeBars")
                            .duration(NFS)
                            .attr("width", bandWidth)
                            .attr("x", function(d) { return x(d.date); });
                    };

                    function resizeFakeBars(path) {
                        path
                            .transition("resizeFakeBars")
                            .duration(NFS)
                            .attr("x", function(d, i) {return x(fakeBars[i][1]); })
                            .attr("width", function(d, i) { return x(fakeBars[i][2])-x(fakeBars[i][1])+bandWidth ; });
                    };

                    function resizeAx(path, a, t, f, ts) {
                        path
                            .transition("resizeAx")
                            .duration(NFS)
                            .call(d3.axisBottom(a)
                                .tickSize(ts)
                                .ticks(t)
                                .tickFormat(d3.timeFormat(f))
                            )
                        .selectAll("text")
                            .attr('text-anchor', 'start')
                            .attr("class", "textSmaller");
                    }

                    function wurstOpaciter(path, v) {
                        path
                            .transition("wurstOpaciter")
                            .duration(NFS)
                            .attr("opacity", v);
                    };

                    function pik(path) {
                        path
                            .transition("pik")
                            .duration(NFS)
                            .attr("height", function(d) { 
                                return d.weeksum*yScaler;
                            })
                            .attr("y", function(d) { return y(d.weeksum); });
                    };

                    function pikMark(path) {
                        
                        path
                            .transition("pikMark")
                            .duration(NFS)
                            .attr("cy", 
                                function() {
                                    return y(marksData[this.id.replace("m", "")][0])-10
                                }
                            )
                            .attr("opacity", 1);
                        };

                    function pikColor(path, colorMode) {
                        path
                            .transition("pikColor")
                            .duration(NFS)
                            .attr("fill", function(d) {

                                if (colorMode == "black") {
                                    return "#b0b0b0";
                                } else if (colorMode == "colored") {
                                    return colorise(d.date, d.weeksum);
                                }

                            });
                    };

                    function pookZero(path) {
                        path
                            .transition("pookZero")
                            .duration(NFS)
                            .attr("height", 0)
                            .attr("y", y(0));
                    };

                    function pook(path) {
                        path
                            .transition("pook")
                            .duration(NFS)
                            .attr("height", wurstH)
                            .attr("y", height-wurstH);
                    };

                    function pookColor(path) {
                        path
                            .transition("pookColor")
                            .duration(NFS)
                            .attr("fill", function(d) { return colorise(d.date, d.weeksum) });
                    };

                    function pookMark(path, o) {
                        path
                            .transition("pookColor")
                            .duration(NFS)
                            .attr("cy", height-wurstH-10)
                            .attr("opacity", o);
                    }

                    function navigate(path, i) {
                        path
                            .transition("navigate")
                            .duration(NFS)
                            .attr("transform", 
                                "translate(" + hTr + "," + navigatorX[i] + ")")
                    };

                    // Scroll

                    let scroll = scroller().container(d3.select('#graphic'));
                        scroll();
                    let lastIndex, activeIndex = 0;

                    scroll.on('active', function(index){

                        activeIndex = index
                        let sign = (activeIndex - lastIndex) < 0 ? -1 : 1;
                        let scrolledSections = d3.range(lastIndex + sign, activeIndex + sign, sign);

                        scrolledSections.forEach(i => {
                            activationFunctions[i][0](
                                activationFunctions[i][1]
                            );
                            if (H<W) {
                                theCircle.call(navigate, i);
                            }
                            
                        })
                        lastIndex = activeIndex;
                    });
                });

            </script>
        </div>
    </div>
</body>
