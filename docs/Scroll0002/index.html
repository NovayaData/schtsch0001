<head>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style> body { margin: 0; } </style>
    <link rel="preconnect" href="https://fonts.gstatic.com">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
    <script src="https://d3js.org/d3.v6.min.js"></script>
</head>
<body>
    <!-- style="overflow: hidden;" -->
    <!-- <div id="headers">
        <h1 class="header1">Украина и республики</h1>
    </div> -->

    <button id="go">go</button>
    <button id="back">back</button>

    <div id="graphic">
        <div id="chartArea" >
            <script>

                var bandWidth;
                var wurstH = 30;
                var NFS = 250;

                const W = document.getElementById('chartArea').clientWidth,
                    H = document.getElementById('chartArea').clientHeight;

                var margin = {
                        top: W*0.15, 
                        bottom: H*0.1, 
                        right: W*0.03,
                        left: W*0.03
                        },
                    width = W - margin.left - margin.right,
                    height = H - margin.top - margin.bottom;

                var x = d3.scaleTime().range([0, width]);
                var y = d3.scaleLinear().range([height, 0]);

                var xAxis = d3.axisBottom(x).tickSize(0);
                var yAxis = d3.axisLeft(y).tickSize(0);

                var svg = d3.select("#chartArea").append("svg")
                        .attr("width", W)
                        .attr("height", H)
                        .append("g")   

                svg.append("defs").append("clipPath")
                        .attr("id", "clip")
                    .append("rect")
                        .attr("width", width)
                        .attr("height", H);

                var focus = svg.append("g")
                    .attr("class", "focus")
                    .attr("width", width-margin.left-margin.right)
                    .attr("height", H)
                    .attr(
                        "transform", 
                        "translate(" + margin.left + "," + margin.top + ")"
                        );
                
                var parseTime = d3.timeParse("%Y-%m-%d");
                
                d3.csv("../data/Scroll0002/violations_Ukraine_Republics.csv").then( function(data) {

                    data.forEach(function(d) {
                        d.date = parseTime(d.date);
                    });

                    var xMin = d3.min(data, function(d) { return d.date; });
                    var xMax = d3.max(data, function(d) { return d.date; });

                    const episodes = {
                        "e1" : [
                            xMin,
                            parseTime("2018-05-20")
                        ],
                        "e2" : [
                            parseTime("2018-05-20"),
                            parseTime("2018-10-07")
                        ],
                        "e3" : [
                            parseTime("2018-10-07"),
                            xMax
                        ]
                    };

                    x.domain([xMin, xMax]);
                    y.domain([0, 400]);

                    focus.append("g")
                        .attr("opacity", 0)
                        .attr("id", "X")
                        .attr("transform", "translate(0," + height + ")")
                        .call(xAxis);

                    focus.append("g")
                        .attr("opacity", 0)
                        .call(yAxis);

                    Object.keys(episodes).forEach( function(episode) {

                        ["ukr", "resp"].forEach(function(cCode) {
                            addLine(cCode, episode);
                        });

                    });
                    
                    function addLine(cCode, episode) {

                        episodeData = data.filter(
                            function(d) { 
                                return d.date >= episodes[episode][0] && d.date <= episodes[episode][1];
                                }
                        );

                        // console.log(episodeData);

                        focus.append("path")
                            .datum(episodeData)
                            .attr("clip-path", "url(#clip)")
                            .attr("class", episode+" "+cCode)
                            .attr("fill", "none")
                            .attr("opacity", 1)
                            .attr("stroke-width", 1.2)
                            .attr("stroke-linejoin", "round")
                            .attr("stroke-linecap", "round")
                            .attr(
                                "d", 
                                d3.line()
                                .curve(d3.curveStep)
                                .x(d => x(d.date))
                                .y(d => y(d[cCode]))
                            );
                    };

                    function cleaned(s, dl) {
                        // var s = Array(a, b);
                        x.domain(s);
                        focus.selectAll(".ukr").call(resizer, "ukr", dl);
                        focus.selectAll(".resp").call(resizer, "resp", dl);
                        focus.select("#X").call(resizeAx, x, dl);
                    };

                    function act(e) {
                        focus.selectAll("path").filter(function() {
                            return !this.classList.contains(e)
                        }).call(hideShow, 0.25);
                        cleaned(episodes[e], 800);
                    };

                    function react() {
                        focus.selectAll("path").call(hideShow, 1);
                        cleaned([xMin, xMax], 0);
                    };

                    // Transitions

                    function hideShow(path, o) {
                        path
                            .transition("hideShow")
                            .duration(400)
                            .attr("opacity", o)
                    };

                    function resizeAx(path, a, dl) {
                        path
                            .transition("resizeAx")
                            .delay(dl)
                            .duration(800)
                            .call(d3.axisBottom(a).tickSize(0));
                    };

                    function resizer(path, c, dl) {
                        path
                        .transition("resizer")
                        .delay(dl)
                        .duration(800)
                        .attr("d", d3.line()
                            .curve(d3.curveStep)
                            .x(function(d) { return x(d.date) })
                            .y(function(d) { return y(d[c]) })
                    )};

                    // Controls

                    var B1 = d3.select("#go");
                    B1.on('click', function() { act("e2"); });

                    var B2 = d3.select("#back");
                    B2.on('click', function() { react(); });

                });

            </script>
        </div>
    </div>
</body>